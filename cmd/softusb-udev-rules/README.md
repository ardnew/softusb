# softusb-udev-rules

Command `softusb-udev-rules` generates udev rules for USB device access on Linux systems.

## Overview

When using the softusb Linux host HAL, applications need read/write access to USB device nodes in `/dev/bus/usb/`. By default, these devices are only accessible to root. This tool generates udev rules that grant access to specific users or groups, eliminating the need to run applications as root.

## Installation

```bash
go install github.com/ardnew/softusb/cmd/softusb-udev-rules@latest
```

Or build from source:

```bash
cd cmd/softusb-udev-rules
go build
```

## Usage

```bash
softusb-udev-rules [flags]
```

### Flags

| Flag | Default | Description |
|------|---------|-------------|
| `-o file` | stdout | Output file path |
| `-vid id` | | Filter by USB Vendor ID (hex) |
| `-pid id` | | Filter by USB Product ID (hex) |
| `-class id` | | Filter by USB device class (hex) |
| `-group name` | `plugdev` | Group to grant access |
| `-mode mode` | `0660` | File permissions |
| `-all` | false | Generate rules for all USB devices |
| `-hid` | false | Generate rules for all HID devices |

At least one of `-all`, `-hid`, `-vid`, or `-class` must be specified.

## Examples

### Specific Device

Generate rules for a specific Logitech device:

```bash
softusb-udev-rules -vid 046d -pid c52b -o /etc/udev/rules.d/99-logitech.rules
```

Output:

```bash
# Generated by softusb-udev-rules
# https://github.com/ardnew/softusb

# Allow access to VID=046d PID=c52b
SUBSYSTEM=="usb", ATTR{idVendor}=="046d", ATTR{idProduct}=="c52b", MODE="0660", GROUP="plugdev"
```

### All HID Devices

Generate rules for all USB HID devices (keyboards, mice, joysticks):

```bash
softusb-udev-rules -hid -o /etc/udev/rules.d/99-hid.rules
```

Output:

```bash
# Generated by softusb-udev-rules
# https://github.com/ardnew/softusb

# Allow access to all USB HID devices
SUBSYSTEM=="usb", ATTR{bInterfaceClass}=="03", MODE="0660", GROUP="plugdev"
# Also allow access to the raw USB device for HID interfaces
SUBSYSTEM=="usb", DRIVER=="usbhid", MODE="0660", GROUP="plugdev"
```

### Vendor-Specific Devices

Generate rules for all devices from a specific vendor:

```bash
softusb-udev-rules -vid 1234 -group users
```

### All USB Devices

Generate rules for all USB devices (use with caution):

```bash
softusb-udev-rules -all -o /etc/udev/rules.d/99-usb-all.rules
```

> **Warning**: Granting access to all USB devices may have security implications. Use this option only in controlled environments.

## Applying Rules

After generating rules, reload udev and trigger a rescan:

```bash
sudo udevadm control --reload-rules
sudo udevadm trigger
```

For the rules to take effect on already-connected devices, you may need to unplug and replug them.

## Group Membership

Users must be members of the specified group (default: `plugdev`) to access the devices. Add a user to the group:

```bash
sudo usermod -aG plugdev $USER
```

Log out and back in for the group membership to take effect.

## Common USB Device Classes

| Class | Hex | Description |
|-------|-----|-------------|
| HID | `03` | Human Interface Device (keyboard, mouse, joystick) |
| Mass Storage | `08` | USB storage devices |
| CDC | `02` | Communication Device Class (serial, modem) |
| Audio | `01` | Audio devices |
| Video | `0e` | Video devices (webcams) |
| Hub | `09` | USB hubs |

Example for CDC devices:

```bash
softusb-udev-rules -class 02 -o /etc/udev/rules.d/99-cdc.rules
```

## Troubleshooting

### Permission Denied

If you still get permission errors after applying rules:

1. Check group membership: `groups $USER`
2. Verify the rules file exists: `ls -la /etc/udev/rules.d/99-*.rules`
3. Check udev logs: `sudo udevadm monitor`
4. Try unplugging and replugging the device

### Rules Not Loading

Verify udev can parse the rules:

```bash
sudo udevadm test /sys/bus/usb/devices/<device>
```

### Finding Device Information

Use `lsusb` to find VID:PID:

```bash
lsusb
# Bus 001 Device 005: ID 046d:c52b Logitech, Inc. Unifying Receiver
```

Use `udevadm` for detailed device information:

```bash
udevadm info -a -n /dev/bus/usb/001/005
```
